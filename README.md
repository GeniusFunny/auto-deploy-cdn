### Auto-Deploy-CDN

### â›°ï¸èƒŒæ™¯

#### å¸¸è§„æµç¨‹

1. å‰ç«¯å¼€å‘å®Œåé€šè¿‡Gitå°†æœ€æ–°çš„ä»£ç æ›´æ–°åˆ°è¿œç¨‹ä»“åº“ä¸­ï¼Œåç«¯git pullä¸‹æ¥åï¼Œæ‰§è¡Œbuildæ“ä½œï¼Œç„¶åå°†é™æ€èµ„æºéƒ¨ç½²åˆ°CDNä¸Šï¼Œéƒ¨ç½²åˆ°CDNä¸Šçš„èµ„æºå¯èƒ½éœ€è¦è¿›è¡Œåˆ·æ–°æ‰èƒ½ç”Ÿæ•ˆï¼Œæœ€åå°†é™¤å»é™æ€èµ„æºçš„æ–‡ä»¶éƒ¨ç½²åˆ°åº”ç”¨æœåŠ¡å™¨ä¸Šã€‚
2. å‰ç«¯ç›´æ¥åœ¨æœ¬åœ°è¿›è¡Œbuildï¼Œå°†buildåçš„ä¸œè¥¿æ‰“åŒ…å‘ç»™åç«¯ï¼Œè®©å…¶è¿›è¡Œéƒ¨ç½²åˆ°CDNã€å‘å¸ƒåº”ç”¨çš„æ“ä½œã€‚

#### ç—›ç‚¹åŠä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåš

é¦–å…ˆï¼Œbuildä¹‹åçš„æ“ä½œæ˜¯åç«¯è´Ÿè´£ï¼Œåç«¯ä¸€èˆ¬ä¼šå†™ä¸€äº›shellè„šæœ¬æ¥è‡ªåŠ¨åŒ–æ‰§è¡Œï¼Œä½†æ˜¯æ¯ä¸ªé¡¹ç›®éƒ½å†™ä¸€ä¸ªshellè„šæœ¬ä¸ç¬¦åˆDRYåŸåˆ™ã€‚

å…¶æ¬¡ï¼Œæ‰“åŒ…åçš„èµ„æºå¼•ç”¨ä½ç½®æ˜¯ç”±å‰ç«¯å†³å®šçš„ï¼ˆwebpacké‡Œçš„publicPathï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éƒ¨ç½²CDNçš„æ“ä½œå®Œå…¨å¯ä»¥è®©æˆ‘ä»¬æ¥åšï¼Œä¸€æ—¦æˆ‘ä»¬buildå¹¶ä¸Šä¼ èµ„æºåˆ°CDNåï¼Œæ‰“å¼€index.htmlå°±å¯ä»¥åšã€é¢„æµ‹è¯•ã€‘ï¼ˆä¸Šçº¿æµ‹è¯•æœå‰çš„æµ‹è¯•ï¼‰ã€‚

æœ€åï¼Œåç«¯çš„èŒè´£åœ¨æ•´ä¸ªé“¾è·¯ä¸­è¢«ç®€åŒ–äº†ï¼Œæˆ‘ä»¬åªè¦æä¾›ä¸€ä¸ªåŒ…å«index.htmlå’Œå…¶ä»–éé™æ€èµ„æºç»™åç«¯å°±OKäº†ï¼Œåç«¯è´Ÿè´£éƒ¨ç½²å°±å®Œäº‹ã€‚

æœ€æœ€æœ€åï¼Œé™æ€èµ„æºåº”è¯¥ä½¿ç”¨contentHashæˆ–è€…chunkHashï¼Œå½“æˆ‘ä»¬è¿­ä»£æ—¶ï¼Œç”¨æˆ·ä¸éœ€è¦å†é‡æ–°ä¸‹è½½æ‰€æœ‰çš„jsæˆ–cssæ–‡ä»¶ï¼Œè€Œæ˜¯å¢é‡ä¸‹è½½ï¼Œæ›´å¥½çš„åˆ©ç”¨äº†ç¼“å­˜ã€‚

### âœ¨æµç¨‹

#### Deploy-CSS-JS

**webpack buildå®Œæˆåå°±è§¦å‘è¿™ä¸ªè¿‡ç¨‹ï¼Œé€šè¿‡npm script hookså®Œæˆ**

1. åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªtempç›®å½•ï¼Œä½œä¸ºåç»­æ“ä½œçš„å·¥ä½œç›®å½•ã€‚
2. åœ¨tempç›®å½•ä¸‹æ‹‰å–SVNä¸Šå·²å­˜åœ¨çš„é™æ€èµ„æºã€‚ï¼ˆä¾‹å¦‚ï¼štemp/testï¼‰
3. å°†buildç›®å½•ä¸‹ä¸­çš„é™æ€èµ„æºç§»åŠ¨åˆ°temp/testç›®å½•ä¸‹ã€‚
4. åœ¨temp/testç›®å½•ä¸‹æ‰§è¡ŒSVNæ›´æ–°çš„æ“ä½œï¼Œè¿™ä¸ªæ—¶å€™å®Œæˆäº†é™æ€èµ„æºçš„éƒ¨ç½²ã€‚
5. å¦‚æœæ–°éƒ¨ç½²çš„èµ„æºéœ€è¦åˆ·æ–°åæ‰èƒ½ç”Ÿæ•ˆï¼Œé‚£ä¹ˆæ‰§è¡Œåˆ·æ–°æ“ä½œï¼ˆè¿™ä¸ªè¿‡ç¨‹å­˜åœ¨å·®å¼‚æ€§ï¼Œå¯ä»¥è¦†å†™refreshCDN.jsï¼‰ã€å¯é€‰ã€‘
6. åˆ é™¤tempç›®å½•ï¼Œå°†buildç›®å½•ä¸‹å‰©ä½™çš„æ–‡ä»¶ç§»å…¥distç›®å½•å¹¶åˆ é™¤buildç›®å½•
7. è¿™ä¸ªæ—¶å€™æ‰§è¡ŒGitæ“ä½œï¼Œæ›´æ–°åˆ°è¿œç¨‹ä»“åº“ã€å¯é€‰ã€‘
8. åç«¯äººå‘˜git pullï¼Œè·å–åˆ°distç›®å½•ï¼Œå°†å…¶éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼Œå¤§åŠŸå‘Šæˆï¼ã€åç«¯æ“ä½œã€‘

#### Deploy-Images

**webpack buildå¼€å§‹å‰è§¦å‘è¿™ä¸ªè¿‡ç¨‹ï¼Œé€šè¿‡npm script hookså®Œæˆ**

1. é¡¹ç›®ä¸­å¯¹å›¾ç‰‡çš„å¼•ç”¨éœ€è¦ä¸­å¿ƒåŒ–ç®¡ç†åˆ°ä¸€ä¸ªjsæ–‡ä»¶ä¸­ï¼Œä¾‹å¦‚images.jsï¼ˆé‡Œé¢åŒ…å«äº†æ‰€æœ‰é¡µé¢/ç»„ä»¶å¼•ç”¨çš„å›¾ç‰‡åœ°å€ï¼‰
2. è¿›è¡Œbuildå‰ï¼Œå¯¼å‡ºæ‰€æœ‰å˜é‡ï¼Œå¯¹è¿™äº›å˜é‡è¿›è¡Œåˆ¤æ–­ï¼šå¦‚æœæ˜¯æœ¬åœ°åœ°å€ï¼Œåˆ™ä¸Šä¼ è¯¥å›¾ç‰‡åˆ°CDNåå¹¶ç”¨urlæ›¿æ¢
3. æ‰§è¡Œwebpack build

### ğŸ“¦ å®‰è£… 

#### npm

```bash
npm i auto-deploy2cdn
```

#### yarn

```bash
yarn add auto-deploy2cdn
```

### ğŸ”¨ä½¿ç”¨æ–¹æ³•

#### Deploy-CSS/JSï¼ˆç”¨äºéƒ¨ç½²é™æ€èµ„æºï¼Œä¾‹å¦‚CSSã€JSï¼‰

##### 1. ç¼–å†™ä¸€ä¸ªdeploy.js

```javascript
const { deployAssets } = require('auto-deploy2cdn')
deployAssets({
  svnDir: 'work',	// svnçš„äºŒçº§ç›®å½•
  svnProjectName: 'test', // é¡¹ç›®çš„åç§°
  svnRemote: 'https://yh.geniusfunny.com/svn/xxstatic/work/test/', // svnä»“åº“çš„è¿œç¨‹åœ°å€
  autoGit: false, // æ˜¯å¦è‡ªåŠ¨GitåŒæ­¥åˆ°è¿œç¨‹ä»“åº“
  autoRefresh: true, // å¦‚æœCDNéƒ¨ç½²åéœ€è¦åˆ·æ–°ï¼Œè¯·è®¾ç½®ä¸ºtrueï¼Œè¿™ä¼šè‡ªåŠ¨åˆ·æ–°CDN
  distDir: 'dist', // å‰”é™¤é™æ€èµ„æºåï¼Œç”¨äºåç«¯éƒ¨ç½²åº”ç”¨çš„æ–‡ä»¶ç›®å½•
  buildDir: 'build', // æ„å»ºå·¥å…·æ‰“åŒ…åçš„buildç›®å½•ï¼Œå¦‚åœ¨æ ¹ç›®å½•ä¸‹çš„buildï¼Œåˆ™buildDirä¸º'build'
  assetsDir: 'build/assets', // é™æ€èµ„æºä½ç½®ï¼Œå¦‚'build/assets'
  includes: ['css', 'js'], // å¦‚æœæœªåˆ¶å®šassetsDirï¼Œåˆ™é»˜è®¤åœ¨buildDirä¸­è¿›è¡Œexcludeæ“ä½œï¼ŒéincludesåŒ…å«çš„æ–‡ä»¶ç±»å‹çš„æ–‡ä»¶å°†ä¸ä¼šè¢«ä¸Šä¼ åˆ°CDN
  refreshHost: 'yh.geniusfunny.com', // è§¦å‘CDNåˆ·æ–°çš„åœ°å€çš„åŸŸå
  refreshPath: '/IT/updateshared/' // è§¦å‘CDNåˆ·æ–°çš„åœ°å€çš„è·¯å¾„
})
```

##### 2. åˆ©ç”¨npm scripts hooks è§¦å‘

```json
  "scripts": {
    "start": "node scripts/start.js",
    "postbuild": "node scripts/deploy.js", // buildå®Œæˆåè§¦å‘
    "build": "node scripts/build.js",
  },
```

#### Deploy-Images

##### 1. ç¼–å†™ä¸€ä¸ªupload.js

```js
const { deployImages } = require('auto-deploy2cdn')
deployImages({
  sourcePath: 'test/constants/images.js', // ç®¡ç†å›¾ç‰‡urlçš„jsæ–‡ä»¶ç›¸å¯¹äºæ ¹ç›®å½•çš„ä½ç½®
  uploadTargetHost: 'xxx.com', // cdnçš„host
  uploadTargetPath: '/upload?a=xxx&b=xxx&c=xxx' // cdnçš„path
})
```

##### 2. åˆ©ç”¨npm scripts hooks è§¦å‘

```json
 "scripts": {
    "start": "node scripts/start.js",
    "prebuild": "node scripts/upload.js", // buildå¼€å§‹å‰è§¦å‘
    "postbuild": "node scripts/deploy.js", 
    "build": "node scripts/build.js",
  },
```